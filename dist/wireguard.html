<!DOCTYPE html>
<html lang="en">

<head>
  <title>TunnlTo - Add WireGuard Tunnel</title>
  <meta charset="UTF-8">
  <script type="module">
    import Tunnel from './js/tunnel.js'

    // Get elements
    let deleteButtonElement
    let deleteDivElement
    let importButtonElement
    let nameElement
    let privateKeyElement
    let interfaceAddressElement
    let dnsElement
    let publicKeyElement
    let presharedKeyElement
    let endpointElement
    let allowedAppsElement
    let disallowedAppsElement
    let allowedIPsElement
    let disallowedIPsElement
    let mtuElement
    let form
    let backButtonElement

    // Wait for DOM content to load
    window.addEventListener('DOMContentLoaded', () => {
      // Get elements
      deleteButtonElement = document.getElementById('deleteButton')
      deleteDivElement = document.getElementById('deleteDiv')
      importButtonElement = document.getElementById('importDiv')
      nameElement = document.getElementById('name')
      privateKeyElement = document.getElementById('privateKey')
      interfaceAddressElement = document.getElementById('interfaceAddress')
      dnsElement = document.getElementById('dns')
      publicKeyElement = document.getElementById('publicKey')
      presharedKeyElement = document.getElementById('presharedKey')
      endpointElement = document.getElementById('endpoint')
      allowedAppsElement = document.getElementById('allowedApps')
      disallowedAppsElement = document.getElementById('disallowedApps')
      allowedIPsElement = document.getElementById('allowedIPs')
      disallowedIPsElement = document.getElementById('disallowedIPs')
      mtuElement = document.getElementById('mtu')
      form = document.getElementById('form')
      importButtonElement = document.getElementById('importButton')
      backButtonElement = document.getElementById('backButton')

      // Setup listeners on elements
      deleteButtonElement.onclick = () => { deleteClick() }
      form.onsubmit = (event) => { submitClick(event) }
      importButtonElement.onclick = () => { importButtonClick() }
      backButtonElement.onclick = () => { navigateToIndex() }

      // Check to see if the user is looking to edit an existing tunnel or add a new one
      if (getUrlParam('edit') === 'true') {
        // User wants to edit an existing tunnel

        // Show the delete button
        deleteDivElement.classList.remove('hidden')

        // Get the values of the tunnel from local storage
        const name = getUrlParam('name')
        const data = JSON.parse(localStorage.getItem(`tunnel-wireguard-${name}`))
        const tunnel = Object.assign(new Tunnel(), data)

        // Add the values to the form
        nameElement.value = tunnel.name
        privateKeyElement.value = tunnel.privateKey
        interfaceAddressElement.value = tunnel.interfaceAddress
        dnsElement.value = tunnel.dns
        publicKeyElement.value = tunnel.publicKey
        presharedKeyElement.value = tunnel.presharedKey
        endpointElement.value = tunnel.endpoint
        allowedAppsElement.value = tunnel.allowedApps
        disallowedAppsElement.value = tunnel.disallowedApps
        allowedIPsElement.value = tunnel.allowedIPs
        disallowedIPsElement.value = tunnel.disallowedIPs
        mtuElement.value = tunnel.mtu
      } else {
        // Show the import button
        importButtonElement.classList.remove('hidden')
      }

      // Now that the UI is set, show the UI
      document.body.classList.remove('invisible')
    })

    /* ------------------------
    End of code that runs on page load
    ------------------------- */

    /* ------------------------
    Beginning of functions
    ------------------------- */

    // Redirect back to the home page
    function navigateToIndex () {
      window.location.href = 'index.html'
    }

    /**
     * Handle form submission
     */
    function submitClick (event) {
      // Validate form before saving any data
      if (!form.checkValidity()) {
        // Form not valid
        event.preventDefault()
        event.stopPropagation()
      } else {
        // Form is valid
        saveFormData()

        // The page will redirect at this point as set by the form action
      }

      form.classList.add('was-validated')
    }

    /**
     * Allow the user to select a WireGuard config file and import the data to the form
     */
    function importButtonClick () {
      const input = document.createElement('input')
      input.type = 'file'
      input.onchange = _ => {
        const files = Array.from(input.files)
        const file = files[0]

        const reader = new FileReader()
        reader.onload = function (progressEvent) {
          // Get the text in the file
          const text = this.result

          // Fill out the form data with what is in the file
          const lines = text.split('\n')
          for (let line = 0; line < lines.length; line++) {
            const lineText = lines[line]
            if (lineText.startsWith('PrivateKey = ')) {
              const x = lineText.replace('PrivateKey = ', '')
              privateKeyElement.value = x
            } else if (lineText.startsWith('Address = ')) {
              const x = lineText.replace('Address = ', '')
              interfaceAddressElement.value = x
            } else if (lineText.startsWith('DNS = ')) {
              const x = lineText.replace('DNS = ', '')
              dnsElement.value = x
            } else if (lineText.startsWith('PublicKey = ')) {
              const x = lineText.replace('PublicKey = ', '')
              publicKeyElement.value = x
            } else if (lineText.startsWith('PresharedKey = ')) {
              const x = lineText.replace('PresharedKey = ', '')
              presharedKeyElement.value = x
            } else if (lineText.startsWith('AllowedIPs = ')) {
              const x = lineText.replace('AllowedIPs = ', '')
              allowedIPsElement.value = x
            } else if (lineText.startsWith('Endpoint = ')) {
              const x = lineText.replace('Endpoint = ', '')
              endpointElement.value = x
            } else if (lineText.startsWith('MTU = ')) {
              const x = lineText.replace('MTU = ', '')
              mtuElement.value = x
            }
          }
        }
        reader.readAsText(file)
      }
      input.click()
    }

    /**
     * Retrieve selected paramater values from the url
     */
    function getUrlParam (parameterName) {
      let result = null
      let tmp = []
      location.search
        .substr(1)
        .split('&')
        .forEach(function (item) {
          tmp = item.split('=')
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1])
        })

      return result
    }

    /**
     * Save the form data to local storage
     */
    function saveFormData () {
      // Save data to local storage.
      const tunnel = new Tunnel(
        nameElement.value,
        privateKeyElement.value,
        interfaceAddressElement.value,
        dnsElement.value,
        publicKeyElement.value,
        presharedKeyElement.value,
        endpointElement.value,
        allowedAppsElement.value,
        disallowedAppsElement.value,
        allowedIPsElement.value,
        disallowedIPsElement.value,
        mtuElement.value
      )

      // Prefix with tunnel-wireguard- to seperate from other local storage data
      // Reminder: local storage is key-value pairs e.g. "name":"foo","privateKey":"bar"
      localStorage.setItem(`tunnel-wireguard-${tunnel.name}`, JSON.stringify(tunnel))
      console.log(`Saved tunnel-wireguard-${tunnel.name} to local storage`)

      // Update the selected tunnel so this new tunnel is selected on the home page
      localStorage.setItem('selectedTunnel', tunnel.name)
    }

    /**
     * Deletes the tunnel from local storage
     */
    function deleteClick () {
      // Get the tunnel name
      const name = getUrlParam('name')
      console.log(`removing ${name} from local storage`)

      // Delete it from local storage
      localStorage.removeItem(`tunnel-wireguard-${name}`)

      // Remove it from the currently selected tunnel in local storage
      localStorage.setItem('selectedTunnel', '')

      navigateToIndex()
    }
  </script>
  <link rel="stylesheet" type="text/css" href="./css/globals.css">
</head>

<style>
  header {
    background-color: var(--background-accent-color-dark);
    padding-left: 50px;
    padding-block: 20px;
  }

  footer {
    display: flex;
    flex: 1;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding-right: 50px;
    padding-left: 50px;
    background-color: var(--background-accent-color-dark);
  }

  input {
    width: 300px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-family: 'HindMadurai', serif;
  }

  label {
    display: block;
    font-size: 0.8em;
    margin-top: 10px;
  }
</style>

<body class="hidden">

  <!-- Using async makes the script run immediately as module is deferred by default -->
  <script type="module" async>
    import { setDarkMode } from './js/globals.js'

    // Set light or dark mode
    setDarkMode()

    // Show the body
    document.body.classList.remove('hidden')
  </script>

  <header>
    <h1>WireGuard Tunnel</h1>
  </header>

  <form class="flex-row" id="form" action="index.html">
    <div class="flex-column"> <!-- Left column -->
      <div>
        <label for="name">Tunnel Name</label>
        <input id="name" type="text" placeholder="Work VPN" required />
      </div>
      <div>
        <label for="interfaceAddress">Interface Address</label>
        <input id="interfaceAddress" type="text" placeholder="10.0.0.1/32" required />
      </div>
      <div>
        <label for="publicKey">Public Key</label>
        <input id="publicKey" type="text" id="publicKey" required />
      </div>
      <div>
        <label for="allowedApps">Allowed Apps</label>
        <input id="allowedApps" type="text" id="allowedApps" placeholder="chrome, msoffice, c:\example.exe" />
      </div>
      <div>
        <label for="disallowedApps">Disallowed Apps</label>
        <input id="disallowedApps" type="text" id="disallowedApps" placeholder="discord, firefox, d:\app.exe" />
      </div>
      <div>
        <label for="mtu">MTU</label>
        <input id="mtu" type="text" id="mtu" placeholder="1420" />
      </div>
    </div>
    <div class="flex-column"> <!-- Right column -->
      <div>
        <label for="privateKey">Private Key</label>
        <input id="privateKey" type="text" required />
      </div>
      <div>
        <label for="dns">DNS</label>
        <input id="dns" type="text" id="dns" value="1.1.1.1, 8.8.8.8" />
      </div>
      <div>
        <label for="presharedKey">Preshared Key</label>
        <input id="presharedKey" type="text" id="presharedKey" />
      </div>
      <div>
        <label for="endpoint">Endpoint</label>
        <input id="endpoint" type="text" id="endpoint" placeholder="10.0.0.100:51820" required />
      </div>
      <div>
        <label for="allowedIPs">Allowed IP's</label>
        <input id="allowedIPs" type="text" id="allowedIPs" value="0.0.0.0/0" />
      </div>
      <div>
        <label for="disallowedIPs">Disallowed IP's</label>
        <input id="disallowedIPs" type="text" id="disallowedIPs" />
      </div>
    </div>
  </form>

  <footer>
    <div>
      <button id="backButton">Back</button>
    </div>
    <div>
      <button id="importButton" class="hidden">Import</button>
      <button id="saveButton">Save</button>
      <button id="deleteButton" class="hidden">Delete</button>
    </div>
  </footer>

</body>

</html>